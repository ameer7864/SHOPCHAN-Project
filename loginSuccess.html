<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOME</title>
    <link rel="stylesheet" href="./styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="shortcut icon" href="./media/logo.png" type="image/x-icon">
    <style>
        body {
            position: relative;
            min-height: 100vh;
        }

        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid lightblue;
            border-right-color: orange;
            animation: l2 1s infinite linear;
            position: absolute;
            top: 50%;
            left: 50%;
            z-index: 999;
        }

        @keyframes l2 {
            to {
                transform: rotate(1turn)
            }
        }
    </style>
</head>

<body>
    <div class="loader" id="loader"></div>
    <div class="toast-container"></div>
    <div class="login-header bg-white d-flex justify-content-between mt-1"></div>
    <div class="item-container"></div>
    <div class="modal fade" id="displayCartModal">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="text-primary">YOUR CART ITEMS</h2>
                    <button class="btn btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="cart-container">

                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let loader = document.getElementById("loader");
        function showToast(message, type = "success") {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast show text-white bg-${type}`;
            toast.innerHTML = `
                <div class="d-flex">
                <div class="toast-body"><strong>${message}</strong></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 2500);
        }
        let userUrl = "http://localhost:3000/users";
        let apiUrl = "https://dummyjson.com/products";
        let loginHeader = document.querySelector(".login-header");
        let itemContainer = document.querySelector(".item-container");
        let urlSearchParams = new URLSearchParams(location.search);
        let userId = urlSearchParams.get("id");
        console.log(userId);

        async function getUserData() {
            let res = await fetch(userUrl);
            let users = await res.json();
            return users;
        }
        //Header >>> buttons-cart , logout
        async function displayHeader() {
            var user;
            let users = await getUserData();
            users.forEach(obj => {
                if (obj.id === userId) {
                    user = obj;
                }
            }); 
            loginHeader.innerHTML = `
                    <div class="logo">
                        <img src="./media/logo.png" height="40" alt="">
                    </div>
                `;
            let item = document.createElement("div");
            item.className = "item d-flex gap-3 justify-content-between align-items-center";
            item.innerHTML = `
                <p class="fw-bold">User: <span class="bg-info p-2 rounded fw-bold text-white">${user.user.toUpperCase()}</span><p>
                <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#displayCartModal" onclick=displayCart()>CART</button>
                <button class="btn btn-success" onclick=logoutUser()>LOGOUT</button>
                `;
            loginHeader.appendChild(item);
            loader.remove()
        }
        displayHeader();

        async function getProductsData() {
            let response = await fetch(apiUrl);
            let result = await response.json();
            let products = result.products;
            localStorage.setItem("products", JSON.stringify(products));
            displayData();
        }
        getProductsData();

        function displayData() {
            let products = JSON.parse(localStorage.getItem("products"))
            products.forEach(product => {
                var { id, images, title, price, brand, category, rating, description } = product;
                let item = document.createElement("div");
                item.className = "login-item";
                item.innerHTML = `
                    <img src="${images[0]}">
                    <p class="fw-bold"><strong>Title :</strong> ${title}</p>
                    <p class="text-primary"><strong>Price :</strong> ${price}$</p>
                    <p><strong>Brand : </strong> ${(brand) ? brand : "Not Available"} </p>
                    <p><strong>Category : </strong> ${category} </p>
                    <button class="btn btn-success" onclick=addToCart('${id}')>Add to Cart</button>
                `;
                itemContainer.appendChild(item);
            })
            setTimeout(() => {
                intersectionObserver();
            }, 0);
        }

        function intersectionObserver() {
            const items = document.querySelectorAll(".login-item");
            console.log(items);
            const handleIntersect = (entries) => {
                for (entry of entries) {
                    if (entry.isIntersecting) {
                        entry.target.classList.add("reveal");
                    }
                    else {
                        entry.target.classList.remove("reveal");
                    }
                }
            }
            const observer = new IntersectionObserver(handleIntersect, {
                threshold: 0.1
            });
            for (item of items) {
                observer.observe(item);
            }
        }

        function logoutUser() {
            let confirm = window.confirm("Do you really want to logout ?");
            if (confirm) {
                showToast("Logout Successful", "success");
                setTimeout(() => {
                    location.href = './index.html';
                }, 500);
            }
        }

        function addToCart(id) {
            let cartArr = (JSON.parse(localStorage.getItem(userId))) ? JSON.parse(localStorage.getItem(userId)) : [];
            let products = JSON.parse(localStorage.getItem("products"))
            let filteredArray = products.filter(obj => obj.id == id);
            cartArr.push(filteredArray[0]);
            let duplicates = cartArr.filter(obj => obj.id == id)
            if (duplicates.length == 1) {
                showToast("Added to Cart", "success");
                localStorage.setItem(userId, JSON.stringify(cartArr));
                window.scroll({
                    top: 0,
                    behavior: "smooth"
                })
            }
            else {
                showToast("Product is already in cart", "warning");
                window.scroll({
                    top: 0,
                    behavior: "smooth"
                })
            }
        }
        //cart-container
        function displayCart() {
            let cartContainer = document.getElementById("cart-container");
            cartContainer.innerHTML = '';
            let cartItems = JSON.parse(localStorage.getItem(userId));
            cartItems.forEach(obj => {
                var { id, images, title, price, brand, category } = obj;
                let item = document.createElement("div");
                item.className = "cart-item border border-2 border-info rounded-3 m-3 p-3"
                item.innerHTML = `
                    <img src="${images[0]}" height="180">
                    <p class="fw-bold"><strong>Title :</strong> ${title}</p>
                    <p class="text-primary"><strong>Price :</strong> ${price}$</p>
                    <p><strong>Brand : </strong> ${(brand) ? brand : "Not Available"} </p>
                    <p><strong>Category : </strong> ${category} </p>
                    <button class="btn btn-danger" onclick=removeFromCart(${id})>Remove</button>
                `;
                cartContainer.appendChild(item);
            });
        }

        function removeFromCart(id) {
            let cartItems = JSON.parse(localStorage.getItem(userId));
            // console.log(cartItems);
            let filteredCart = cartItems.filter(obj => obj.id != id);
            showToast("Removed from cart successfully");
            localStorage.setItem(userId, JSON.stringify(filteredCart));
            displayCart();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>